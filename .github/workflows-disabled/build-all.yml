name: ğŸš€ Build All Platforms

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: false
        default: '1.0.0'

jobs:
  # å¹¶è¡Œæ„å»ºæ‰€æœ‰å¹³å°
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: ğŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: ğŸ“± Install dependencies
        run: npm ci
          
      - name: ğŸ”¨ Build Android APKs
        run: |
          cd android
          ./gradlew assembleDebug assembleRelease --no-daemon
          
      - name: ğŸ“¤ Upload Android APKs
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: android/app/build/outputs/apk/**/*.apk

  build-ios:
    runs-on: macos-latest
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true
          working-directory: ios
      
      - name: ğŸ“± Install dependencies
        run: npm ci
          
      - name: ğŸ“¦ Install CocoaPods
        run: |
          cd ios
          pod install --repo-update
          
      - name: ğŸ”¨ Build iOS Archive
        run: |
          cd ios
          xcodebuild \
            -workspace NewApiApp.xcworkspace \
            -scheme NewApiApp \
            -sdk iphoneos \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath NewApiApp.xcarchive \
            archive \
            CODE_SIGNING_ALLOWED=NO
            
      - name: ğŸ“¤ Upload iOS Archive
        uses: actions/upload-artifact@v4
        with:
          name: ios-archive
          path: ios/NewApiApp.xcarchive

  # åˆ›å»ºå‘å¸ƒåŒ…
  create-release:
    needs: [build-android, build-ios]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: ğŸ“¦ Download Android APKs
        uses: actions/download-artifact@v4
        with:
          name: android-apks
          path: ./android-builds
      
      - name: ğŸ“¦ Download iOS Archive
        uses: actions/download-artifact@v4
        with:
          name: ios-archive
          path: ./ios-builds
          
      - name: ğŸ“‹ Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            android-builds/**/*.apk
            ios-builds/**/*
          body: |
            ## ğŸ‰ New API Manager Release
            
            ### ğŸ“± Android
            - `NewApi-debug-v1.0.apk` - Debugç‰ˆæœ¬ (å¼€å‘æµ‹è¯•)
            - `NewApi-release-v1.0.apk` - Releaseç‰ˆæœ¬ (ç”Ÿäº§ä½¿ç”¨)
            
            ### ğŸ iOS  
            - `NewApiApp.xcarchive` - iOS Archive (éœ€è¦Xcodeç­¾å)
            
            ### ğŸš€ åŠŸèƒ½ç‰¹æ€§
            - âœ… æ”¯æŒå¤šä¸ªnew-apiå®ä¾‹ç®¡ç†
            - âœ… å®æ—¶ç›‘æ§å’Œæ•°æ®å±•ç¤º
            - âœ… Material Designç°ä»£åŒ–ç•Œé¢
            - âœ… å®Œæ•´çš„TypeScriptç±»å‹å®‰å…¨
            
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 